# 第二章 编译和链接

## 2.1 被隐藏的过程

C 语言程序从源代码到可执行文件可以总结为 4 个步骤：预处理（Prepressing）、编译（Compilation）、汇编（Assembly）和链接（Linking）。

### 2.1.1 预编译

预编译过程主要处理那些源代码文件中以 ``#`` 开头的预编译指令，比如 ``#include``、``define`` 等。

### 2.1.2 编译

编译过程就是对预处理之后的文件进行一系列词法分析、语法分析、语义分析及优化后生产相应的汇编代码文件。

GCC 把预编译和编译两个步骤合并成了一个步骤，使用一个叫做 cc1 的程序来完成。

### 2.1.3 汇编

汇编是将汇编代码转变成机器可以执行的指令，每一个汇编语句几乎都对应一条机器指令。

### 2.1.4 链接

将不同模块的目标文件连接成一个库或者可执行文件。

## 2.2 编译器做了什么

编译过程一般可以分为 6 步：词法分析、语法分析、语义分析、源代码优化、代码生成和目标代码优化。

### 2.2.1 词法分析

将源代码的字符序列分割成一系列的记号（Token），记号一般可以分为这样几类：关键字、标识符、字面量（包含数字、字符串等）和特殊符号（加号、等号等）。

### 2.2.2 语法分析

根据词法分析产生的记号生成语法树（Syntax Tree），整个分析过程采用上下文无关语法的分析手段。
简单地讲，语法树就是以表达式（Expression）为节点的数。

符号和数字是最小的表达式，他们不是由其他的表达式来组成的，所以通常作为整个语法树的叶节点。

### 2.2.3 语义分析

语法分析只完成了表达式层面的语法分析，并不了解这个语句是否真正有意义。语义分析就是分析语法树的静态语义，也就是是否符合源代码的编程标准，包括声明和类型的匹配，类型的转换等。
如果有些类型需要做隐式转换，语义分析程序则会在语法树中插入相应的转换节点。

### 2.2.4 中间语言生成

将语法树生成中间语言，同时完成源码级别的优化，比如 ``2 + 6`` 这样的常数相加就可以直接在编译阶段完成。

中间代码有很多类型，常见的有：三地址码（Three-address Code）和 P-代码（P-Code）。

### 2.2.5 目标代码生成和优化

从中间语言到目标代码这部分称为编译器后端，编译器后端主要包括代码生成器和目标代码优化器。

生成目标代码这一过程非常依赖目标机器，因为不同的机器有着不同的字长、寄存器、整数数据类型和浮点数数据类型等。目标代码的优化通常包括选择合适的寻址方式、使用位移来代替乘法运算、删除多余的指令等。

## 2.3 链接器年龄比编译器长

## 2.4 模块拼装-静态链接

模块链接过程包括地址和空间分配（Address and Storage Allocation）、符号决议（Symbol Resolution）和重定位（Relocation）等步骤。